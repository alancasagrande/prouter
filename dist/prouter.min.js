!function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t(require,exports,module):e.Prouter=t()}(this,function(e,t,r){var n="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global,o={mode:"hash",keys:!0,root:"/",rerouting:!0},s=/\((.*?)\)/g,i=/(\(\?)?:\w+/g,a=/\*\w+/g,l=/[\-{}\[\]+?.,\\\^$|#\s]/g,c=function(){function e(){}return e._extractKeys=function(e){var t=e.match(/:([^\/]+)/g);if(t){for(var r=[],n=0;n<t.length;n++)r[n]=t[n].replace(/[:\(\)]/g,"");return r}return null},e._routeToRegExp=function(e){return e=e.replace(l,"\\$&").replace(s,"(?:$1)?").replace(i,function(e,t){return t?e:"([^/?]+)"}).replace(a,"([^?]*)"),new RegExp("^"+e+"(?:\\?*([^/]*))")},e._clearSlashes=function(e){return e.replace(/\/$/,"").replace(/^\//,"")},e._extractParameters=function(e,t){var r=e.exec(t).slice(1);return r.map(function(e,t){return t===r.length-1?e||null:e?n.decodeURIComponent(e):null})},e._parseQuery=function(e){for(var t={},r=e.split("&"),o=0;o<r.length;o++){var s=r[o].split("="),i=n.decodeURIComponent(s[0]);t[i]=n.decodeURIComponent(s[1])}return t},e._prepareArguments=function(t,r){var n=t.length-1,o=t[n];if(r){for(var s={},i=0;i<r.length;i++)s[r[i]]=t[i];t[r.length]&&(s.query=e._parseQuery(t[r.length])),t=[s]}else o&&o.indexOf("=")>-1&&(t[n]=e._parseQuery(o));return t},e}(),h=function(){function e(){this._routes=[],this._options=JSON.parse(JSON.stringify(o))}return e.prototype.add=function(e,t){var r,n;return"function"==typeof e?(t=e,n=/.*/):(r=c._extractKeys(e),n=c._routeToRegExp(e)),this._routes.push({path:n,callback:t,keys:r,alias:e}),this},e.prototype.remove=function(e){for(var t=this._routes.length-1;t>=0;t--){var r=this._routes[t];(e===r.alias||e===r.callback||e===r.path)&&this._routes.splice(t,1)}return this},e.prototype.check=function(e,t,r){for(var n=0;n<this._routes.length;n++){var o=this._routes[n],s=e.match(o.path);if(s){var i=c._extractParameters(o.path,e),a=this._options.keys?o.keys:null;i=c._prepareArguments(i,a);var l=e.slice(0,s[0].length)!==r.slice(0,s[0].length),h={alias:o.alias,callback:o.callback,params:i,routes:[],rootRerouting:this._options.rerouting||l};t.push(h),o.facade&&(e=e.slice(s[0].length,e.length),r=r.slice(s[0].length,r.length),o.facade.check(e,h.routes,r));break}}return t},e.prototype.drop=function(){return this._routes=[],this.config(o),this},e.prototype.config=function(e){return e&&(this._options.keys=e.keys,this._options.mode=e.mode?e.mode:this._options.mode,this._options.root=e.root?"/"+c._clearSlashes(e.root)+"/":this._options.root,this._options.root=this._options.root.replace(/\/{2,}/,"/"),this._options.rerouting=e.rerouting),this},e.prototype.to=function(t){for(var r,n=0;n<this._routes.length;n++){var o=this._routes[n];if(t===o.alias){r=o.facade,r||(r=new e,r.config(this._options),o.facade=r);break}}return r},e}(),u=function(){function e(){}return e.drop=function(){return this._lastURL="",this._firstLevel.drop()},e.listen=function(){var e=this;if(this._listening)throw new Error("Prouter already listening");n.addEventListener("hashchange",function(){var t=e.getCurrent();e.check(t)},!1),n.addEventListener("popstate",function(t){if(null!==t.state&&void 0!==t.state){var r=e.getCurrent();e.check(r)}},!1),this._listening=!0},e.check=function(e){var t=this._firstLevel.check(e,[],this._lastURL);return this._apply(t),this._firstLevel},e.navigate=function(e){var t=this._firstLevel._options.mode;switch(t){case"history":n.history.pushState(null,null,this._firstLevel._options.root+c._clearSlashes(e));break;case"hash":n.location.href=n.location.href.replace(/#(.*)$/,"")+"#"+e;break;case"node":this._lastURL=e}return this._firstLevel},e.route=function(e){return"node"===this._firstLevel._options.mode&&this.check(e),this._rollback||this.navigate(e),this._rollback=!1,this._firstLevel},e.config=function(e){return this._firstLevel.config(e)},e.to=function(e){return this._firstLevel.to(e)},e.add=function(e,t){return this._firstLevel.add(e,t)},e.remove=function(e){return this._firstLevel.remove(e)},e.getCurrent=function(){var e=this._firstLevel._options.mode,t=this._firstLevel._options.root,r=this._lastURL;if("history"===e)r=c._clearSlashes(n.decodeURI(n.location.pathname+n.location.search)),r=r.replace(/\?(.*)$/,""),r="/"!==t?r.replace(t,""):r,r=c._clearSlashes(r);else if("hash"===e){var o=n.location.href.match(/#(.*)$/);r=o?o[1]:"",r=c._clearSlashes(r)}return r},e.on=function(e,t){return void 0===this._eventHandlers[e]&&(this._eventHandlers[e]=[]),this._eventHandlers[e].push(t),this},e.off=function(e,t){if(this._eventHandlers[e])for(var r=this._eventHandlers[e],n=0;n<r.length;n++)if(r[n]===t){r.splice(n,1),0===r.length&&delete this._eventHandlers[e];break}return this},e._applyNested=function(t){return function(r){r===!1?(e._rollback=!0,e.navigate(e._lastURL)):"string"==typeof r?e.route(r):t&&t.length&&e._apply(t)}},e._apply=function(e){if(e)for(var t,r=0;r<e.length;r+=1){var n=e[r];n.rootRerouting&&(t=n.callback.apply(null,n.params)),this._applyNested(n.routes)(t)}},e._firstLevel=new h,e._eventHandlers={},e._lastURL="",e._rollback=!1,e._listening=!1,e}();return u});